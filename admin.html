<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PL Predictor – Admin</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;max-width:1100px;margin:30px auto;padding:0 16px;line-height:1.5}
  header{text-align:center;margin-bottom:16px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:12px 0}
  input[type=text]{width:680px;max-width:90%;padding:8px;border:1px solid #ddd;border-radius:8px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
  table{border-collapse:collapse;width:100%;margin-top:16px}
  th,td{border:1px solid #ddd;padding:6px 8px;text-align:left}
  th{background:#fafafa}
  .muted{color:#666}
  .ok{color:#0a7b2f;font-weight:600}
  .err{color:#b00020;font-weight:600}
</style>
</head>
<body>
<header>
  <h1>Admin – Download All Predictions</h1>
  <p class="muted">Step 1: Paste your Google Apps Script Web App URL below and click <b>Save URL</b>. Step 2: Click <b>Load</b> to fetch all predictions. Step 3: <b>Export to Excel</b>.</p>
</header>

<div class="controls">
  <input id="apiUrlInput" type="text" placeholder="Paste your Web App URL (looks like https://script.google.com/macros/s/AKfycbx.../exec)" />
  <button id="saveUrlBtn">Save URL</button>
  <button id="loadBtn">Load</button>
  <button id="exportBtn">Export to Excel</button>
</div>

<div id="status"></div>
<div id="tableWrap"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const STORAGE_KEY = 'plp_api_url';
  function getApiUrl(){ return localStorage.getItem(STORAGE_KEY) || 'https://script.google.com/macros/s/AKfycbx99lxiy9mAJYMTqeYyvxnNQ2UNnrDq0Zk9gh6mWmACtTmjUsUYipZCEUAw3IeZdHzW/exec'; }
  function setApiUrl(u){ localStorage.setItem(STORAGE_KEY, u); }
  document.getElementById('apiUrlInput').value = getApiUrl();

  let rows = []; // loaded data

  async function loadAll(){
    const status = document.getElementById('status');
    status.textContent='Loading...';
    status.className='';

    try{
      const url = getApiUrl() + '?op=all';
      const res = await fetch(url, { method:'GET' });
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      rows = data.rows || [];
      status.textContent = `Loaded ${rows.length} rows ✓`;
      status.className = 'ok';
      renderTable();
    }catch(e){
      status.textContent = 'Error: ' + e.message;
      status.className = 'err';
    }
  }

  function renderTable(){
    const wrap = document.getElementById('tableWrap');
    if(rows.length===0){ wrap.innerHTML = '<p class="muted">No data yet.</p>'; return; }
    const headers = Object.keys(rows[0]);
    let html = '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
    for(const r of rows){
      html += '<tr>' + headers.map(h=>`<td>${r[h]}</td>`).join('') + '</tr>';
    }
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  function exportExcel(){
    if(rows.length===0) return;
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Predictions');
    XLSX.writeFile(wb, 'PLP_Predictions.xlsx');
  }

  document.getElementById('saveUrlBtn').addEventListener('click',()=>{
    const v = document.getElementById('apiUrlInput').value.trim();
    if(v) setApiUrl(v);
  });
  document.getElementById('loadBtn').addEventListener('click', loadAll);
  document.getElementById('exportBtn').addEventListener('click', exportExcel);
</script>
</body>
</html>
